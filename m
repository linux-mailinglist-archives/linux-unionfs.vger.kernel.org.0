Return-Path: <linux-unionfs-owner@vger.kernel.org>
X-Original-To: lists+linux-unionfs@lfdr.de
Delivered-To: lists+linux-unionfs@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 147CC7C95EC
	for <lists+linux-unionfs@lfdr.de>; Sat, 14 Oct 2023 20:20:59 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231330AbjJNSU6 (ORCPT <rfc822;lists+linux-unionfs@lfdr.de>);
        Sat, 14 Oct 2023 14:20:58 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53558 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S233033AbjJNSU5 (ORCPT
        <rfc822;linux-unionfs@vger.kernel.org>);
        Sat, 14 Oct 2023 14:20:57 -0400
Received: from mail-ej1-x629.google.com (mail-ej1-x629.google.com [IPv6:2a00:1450:4864:20::629])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AE98C11B
        for <linux-unionfs@vger.kernel.org>; Sat, 14 Oct 2023 11:20:43 -0700 (PDT)
Received: by mail-ej1-x629.google.com with SMTP id a640c23a62f3a-9ba081173a3so516404366b.1
        for <linux-unionfs@vger.kernel.org>; Sat, 14 Oct 2023 11:20:43 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=szeredi.hu; s=google; t=1697307642; x=1697912442; darn=vger.kernel.org;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:from:to:cc:subject:date:message-id:reply-to;
        bh=baWXawfgeqWrx358y3tESksq8gpC1kYNPItFq1D9aQ8=;
        b=oR/GReH8biT/rdDc7GrJiFNWKGDDWydKB9sRET1HLRVDORGMdYwm5dCnx+MuKHpbgO
         UlUfYR9+xwQNI2qJuc8cgB0AH5j0OMhdk657jsfwgonGuqVXl0RYJsbK2EKiqEGl2ETd
         S4lhZlnbmMwHLal29i1Pdq2NKf+breH6+tepI=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20230601; t=1697307642; x=1697912442;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:x-gm-message-state:from:to:cc:subject:date:message-id
         :reply-to;
        bh=baWXawfgeqWrx358y3tESksq8gpC1kYNPItFq1D9aQ8=;
        b=tveAx7vTeolLt4aAzGYTR7oZ5fvLUimiPAXE3fQ1eXCnh569jB9jVNqkTB02/qW9nF
         6XR+x+cMfjk9HCUfilPkKfv+2UsaA8Yfsm91ghR+abHxFl9Wpoai9b8ByGBIjwon2Cgv
         zz1Uc2S5S1Ny80dhLGp3Z6LfkcNPJbEVnUks3xLmQHBm2gLTzzVEiXqlyHTC8GEo5Ls9
         zywhT8g2rI12h4jjyeBvb04fHBItD3vfu5t+7o9plef+O7mmI4H8ZHz1tRpXnsF4fsvD
         4F0QFuc2o18o6F0opF0K9hD2FqRdKypqWgvwnRKcJuNTlB1I2opnZH9etF7RYs48CkXz
         RjYA==
X-Gm-Message-State: AOJu0YxSqmc+/KiCs0Ehf7YZ0UZ0JYiLDAk6xM1yQAvxHN4Wu9Mklhnp
        mDhBoFTpMKwtE6HQ0zWSUEZLxMDTtANowQeX2ZOpSQ==
X-Google-Smtp-Source: AGHT+IGaLnFOcxv0IXgg/OzKl4FWLCG/WJS4xcVajhEIN1KwRUb4EvOE7J2kPbo6z7Y9OtFkJzXGySA4v7Goc/YIXN0=
X-Received: by 2002:a17:907:3f20:b0:9bf:60f9:9b7f with SMTP id
 hq32-20020a1709073f2000b009bf60f99b7fmr988714ejc.4.1697307641911; Sat, 14 Oct
 2023 11:20:41 -0700 (PDT)
MIME-Version: 1.0
References: <20231011164613.1766616-1-amir73il@gmail.com> <CAJfpegvgePB-==T=yTU1R+JVxKYsU_Bm18vWdW5hXWLGw=47PQ@mail.gmail.com>
 <CAOQ4uxiE89q62JHnxwm14FBShPORmX_h0EyDCBN-VKv6aTf5BQ@mail.gmail.com>
 <CAJfpegsexQsNVMOZw+0byzj2wTbU_Tg6p0ATgwBAwmTaDmNbLA@mail.gmail.com>
 <CAOQ4uxjYGckJA=raAW8wyVmDaK-FXfFDRS0RCpZYcLucPqMi3w@mail.gmail.com>
 <CAJfpegt5COamxm-ZN+A9ub_Te-CPM0xMd-Rrzwv7OHBkvHS3yg@mail.gmail.com>
 <CAOQ4uxic3NDtEt9EiP+RYKGEB=6b_PCaudQA=cXK6mWY4Cmeqg@mail.gmail.com> <CAJfpegsr3A4YgF2YBevWa6n3=AcP7hNndG6EPMu3ncvV-AM71A@mail.gmail.com>
In-Reply-To: <CAJfpegsr3A4YgF2YBevWa6n3=AcP7hNndG6EPMu3ncvV-AM71A@mail.gmail.com>
From:   Miklos Szeredi <miklos@szeredi.hu>
Date:   Sat, 14 Oct 2023 20:20:30 +0200
Message-ID: <CAJfpegt7VC94KkRtb1dfHG8+4OzwPBLYqhtc8=QFUxpFJE+=RQ@mail.gmail.com>
Subject: Re: [PATCH] ovl: fix regression in showing lowerdir mount option
To:     Amir Goldstein <amir73il@gmail.com>
Cc:     Christian Brauner <brauner@kernel.org>,
        linux-unionfs@vger.kernel.org, Karel Zak <kzak@redhat.com>
Content-Type: multipart/mixed; boundary="000000000000123f730607b13b92"
X-Spam-Status: No, score=-2.1 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_BLOCKED,
        SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-unionfs.vger.kernel.org>
X-Mailing-List: linux-unionfs@vger.kernel.org

--000000000000123f730607b13b92
Content-Type: text/plain; charset="UTF-8"

On Sat, 14 Oct 2023 at 19:31, Miklos Szeredi <miklos@szeredi.hu> wrote:

> If you can code this up quickly, that's good.  I can have a go at it
> on Monday, but my PoC patch needs splitting up and so it's not ready
> for 6.6.

Attaching my current patch (against your 3 patches).

Thanks,
Miklos

--000000000000123f730607b13b92
Content-Type: text/x-patch; charset="US-ASCII"; name="ovl-layer-lookup.patch"
Content-Disposition: attachment; filename="ovl-layer-lookup.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_lnqd4ok10>
X-Attachment-Id: f_lnqd4ok10

SW5kZXg6IGxpbnV4L2ZzL292ZXJsYXlmcy9wYXJhbXMuYwo9PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ci0tLSBsaW51eC5v
cmlnL2ZzL292ZXJsYXlmcy9wYXJhbXMuYwkyMDIzLTEwLTE0IDIwOjE4OjI0LjY5MDY5Njg0MiAr
MDIwMAorKysgbGludXgvZnMvb3ZlcmxheWZzL3BhcmFtcy5jCTIwMjMtMTAtMTQgMjA6MTg6MzEu
MzE4NzEzNDcwICswMjAwCkBAIC00Myw4ICs0MywxMCBAQCBtb2R1bGVfcGFyYW1fbmFtZWQobWV0
YWNvcHksIG92bF9tZXRhY29wCiBNT0RVTEVfUEFSTV9ERVNDKG1ldGFjb3B5LAogCQkgIkRlZmF1
bHQgdG8gb24gb3Igb2ZmIGZvciB0aGUgbWV0YWRhdGEgb25seSBjb3B5IHVwIGZlYXR1cmUiKTsK
IAotZW51bSB7CitlbnVtIG92bF9vcHQgewogCU9wdF9sb3dlcmRpciwKKwlPcHRfbG93ZXJkaXJf
YWRkLAorCU9wdF9kYXRhZGlyX2FkZCwKIAlPcHRfdXBwZXJkaXIsCiAJT3B0X3dvcmtkaXIsCiAJ
T3B0X2RlZmF1bHRfcGVybWlzc2lvbnMsCkBAIC0xNDAsMTAgKzE0MiwxMyBAQCBzdGF0aWMgaW50
IG92bF92ZXJpdHlfbW9kZV9kZWYodm9pZCkKICNkZWZpbmUgZnNwYXJhbV9zdHJpbmdfZW1wdHko
TkFNRSwgT1BUKSBcCiAJX19mc3BhcmFtKGZzX3BhcmFtX2lzX3N0cmluZywgTkFNRSwgT1BULCBm
c19wYXJhbV9jYW5fYmVfZW1wdHksIE5VTEwpCiAKKwogY29uc3Qgc3RydWN0IGZzX3BhcmFtZXRl
cl9zcGVjIG92bF9wYXJhbWV0ZXJfc3BlY1tdID0gewogCWZzcGFyYW1fc3RyaW5nX2VtcHR5KCJs
b3dlcmRpciIsICAgIE9wdF9sb3dlcmRpciksCi0JZnNwYXJhbV9zdHJpbmcoInVwcGVyZGlyIiwg
ICAgICAgICAgT3B0X3VwcGVyZGlyKSwKLQlmc3BhcmFtX3N0cmluZygid29ya2RpciIsICAgICAg
ICAgICBPcHRfd29ya2RpciksCisJZnNwYXJhbV9wYXRoKCJsb3dlcmRpcisiLCAgICAgICAgICAg
T3B0X2xvd2VyZGlyX2FkZCksCisJZnNwYXJhbV9wYXRoKCJkYXRhZGlyKyIsICAgICAgICAgICAg
T3B0X2RhdGFkaXJfYWRkKSwKKwlmc3BhcmFtX3BhdGgoInVwcGVyZGlyIiwgICAgICAgICAgICBP
cHRfdXBwZXJkaXIpLAorCWZzcGFyYW1fcGF0aCgid29ya2RpciIsICAgICAgICAgICAgIE9wdF93
b3JrZGlyKSwKIAlmc3BhcmFtX2ZsYWcoImRlZmF1bHRfcGVybWlzc2lvbnMiLCBPcHRfZGVmYXVs
dF9wZXJtaXNzaW9ucyksCiAJZnNwYXJhbV9lbnVtKCJyZWRpcmVjdF9kaXIiLCAgICAgICAgT3B0
X3JlZGlyZWN0X2Rpciwgb3ZsX3BhcmFtZXRlcl9yZWRpcmVjdF9kaXIpLAogCWZzcGFyYW1fZW51
bSgiaW5kZXgiLCAgICAgICAgICAgICAgIE9wdF9pbmRleCwgb3ZsX3BhcmFtZXRlcl9ib29sKSwK
QEAgLTIyNSwzNiArMjMwLDYgQEAgc3RhdGljIHNzaXplX3Qgb3ZsX3BhcnNlX3BhcmFtX3NwbGl0
X2xvdwogCXJldHVybiBucl9sYXllcnM7CiB9CiAKLXN0YXRpYyBpbnQgb3ZsX21vdW50X2Rpcl9u
b2VzYyhjb25zdCBjaGFyICpuYW1lLCBzdHJ1Y3QgcGF0aCAqcGF0aCkKLXsKLQlpbnQgZXJyID0g
LUVJTlZBTDsKLQotCWlmICghKm5hbWUpIHsKLQkJcHJfZXJyKCJlbXB0eSBsb3dlcmRpclxuIik7
Ci0JCWdvdG8gb3V0OwotCX0KLQllcnIgPSBrZXJuX3BhdGgobmFtZSwgTE9PS1VQX0ZPTExPVywg
cGF0aCk7Ci0JaWYgKGVycikgewotCQlwcl9lcnIoImZhaWxlZCB0byByZXNvbHZlICclcyc6ICVp
XG4iLCBuYW1lLCBlcnIpOwotCQlnb3RvIG91dDsKLQl9Ci0JZXJyID0gLUVJTlZBTDsKLQlpZiAo
b3ZsX2RlbnRyeV93ZWlyZChwYXRoLT5kZW50cnkpKSB7Ci0JCXByX2VycigiZmlsZXN5c3RlbSBv
biAnJXMnIG5vdCBzdXBwb3J0ZWRcbiIsIG5hbWUpOwotCQlnb3RvIG91dF9wdXQ7Ci0JfQotCWlm
ICghZF9pc19kaXIocGF0aC0+ZGVudHJ5KSkgewotCQlwcl9lcnIoIiclcycgbm90IGEgZGlyZWN0
b3J5XG4iLCBuYW1lKTsKLQkJZ290byBvdXRfcHV0OwotCX0KLQlyZXR1cm4gMDsKLQotb3V0X3B1
dDoKLQlwYXRoX3B1dF9pbml0KHBhdGgpOwotb3V0OgotCXJldHVybiBlcnI7Ci19Ci0KIHN0YXRp
YyB2b2lkIG92bF91bmVzY2FwZShjaGFyICpzKQogewogCWNoYXIgKmQgPSBzOwpAQCAtMjY4LDcw
ICsyNDMsMTc5IEBAIHN0YXRpYyB2b2lkIG92bF91bmVzY2FwZShjaGFyICpzKQogCX0KIH0KIAot
c3RhdGljIGludCBvdmxfbW91bnRfZGlyKGNvbnN0IGNoYXIgKm5hbWUsIHN0cnVjdCBwYXRoICpw
YXRoLCBib29sIHVwcGVyKQorc3RhdGljIGludCBvdmxfbW91bnRfZGlyX2NoZWNrKHN0cnVjdCBm
c19jb250ZXh0ICpmYywgY29uc3Qgc3RydWN0IHBhdGggKnBhdGgsCisJCQkgICAgICAgZW51bSBv
dmxfb3B0IGxheWVyLCBjb25zdCBjaGFyICpuYW1lKQogewotCWludCBlcnIgPSAtRU5PTUVNOwot
CWNoYXIgKnRtcCA9IGtzdHJkdXAobmFtZSwgR0ZQX0tFUk5FTCk7CisJc3RydWN0IG92bF9mc19j
b250ZXh0ICpjdHggPSBmYy0+ZnNfcHJpdmF0ZTsKIAotCWlmICh0bXApIHsKLQkJb3ZsX3VuZXNj
YXBlKHRtcCk7Ci0JCWVyciA9IG92bF9tb3VudF9kaXJfbm9lc2ModG1wLCBwYXRoKTsKKwlpZiAo
b3ZsX2RlbnRyeV93ZWlyZChwYXRoLT5kZW50cnkpKQorCQlyZXR1cm4gaW52YWxmYyhmYywgImZp
bGVzeXN0ZW0gb24gJXMgbm90IHN1cHBvcnRlZCIsIG5hbWUpOwogCi0JCWlmICghZXJyICYmIHVw
cGVyICYmIHBhdGgtPmRlbnRyeS0+ZF9mbGFncyAmIERDQUNIRV9PUF9SRUFMKSB7Ci0JCQlwcl9l
cnIoImZpbGVzeXN0ZW0gb24gJyVzJyBub3Qgc3VwcG9ydGVkIGFzIHVwcGVyZGlyXG4iLAotCQkJ
ICAgICAgIHRtcCk7Ci0JCQlwYXRoX3B1dF9pbml0KHBhdGgpOwotCQkJZXJyID0gLUVJTlZBTDsK
KwlpZiAoIWRfaXNfZGlyKHBhdGgtPmRlbnRyeSkpCisJCXJldHVybiBpbnZhbGZjKGZjLCAiJXMg
aXMgbm90IGEgZGlyZWN0b3J5IiwgbmFtZSk7CisKKwlpZiAobGF5ZXIgPT0gT3B0X3VwcGVyZGly
IHx8IGxheWVyID09IE9wdF93b3JrZGlyKSB7CisJCWlmIChwYXRoLT5kZW50cnktPmRfZmxhZ3Mg
JiBEQ0FDSEVfT1BfUkVBTCkKKwkJCXJldHVybiBpbnZhbGZjKGZjLCAiZmlsZXN5c3RlbSBub3Qg
c3VwcG9ydGVkIGFzICVzIiwgbmFtZSk7CisJCS8qCisJCSAqIENoZWNrIHdoZXRoZXIgdXBwZXIg
cGF0aCBpcyByZWFkLW9ubHkgaGVyZSB0byByZXBvcnQgZmFpbHVyZXMKKwkJICogZWFybHkuIERv
bid0IGZvcmdldCB0byByZWNoZWNrIHdoZW4gdGhlIHN1cGVyYmxvY2sgaXMgY3JlYXRlZAorCQkg
KiBhcyB0aGUgbW91bnQgYXR0cmlidXRlcyBjb3VsZCBjaGFuZ2UuCisJCSAqLworCQlpZiAoX19t
bnRfaXNfcmVhZG9ubHkocGF0aC0+bW50KSkKKwkJCXJldHVybiBpbnZhbGZjKGZjLCAiJXMgaXMg
cmVhZC1vbmx5IiwgbmFtZSk7CisJfSBlbHNlIHsKKwkJaWYgKGN0eC0+bnIgPT0gT1ZMX01BWF9T
VEFDSykKKwkJCXJldHVybiBpbnZhbGZjKGZjLCAidG9vIG1hbnkgbG93ZXIgZGlyZWN0b3JpZXMs
IGxpbWl0IGlzICVkIiwgT1ZMX01BWF9TVEFDSyk7CisJCWlmIChjdHgtPm5yX2RhdGEgJiYgbGF5
ZXIgPT0gT3B0X2xvd2VyZGlyX2FkZCkKKwkJCXJldHVybiBpbnZhbGZjKGZjLCAicmVndWxhciBs
b3dlciBsYXllcnMgY2Fubm90IGZvbGxvdyBkYXRhIGxheWVycyIpOworCX0KKwlyZXR1cm4gMDsK
K30KKworc3RhdGljIGNoYXIgKmVzY2FwZV9jb2xvbnMoY2hhciAqcywgY2hhciAqcCkKK3sKKwlj
aGFyICpyZXQgPSBzOworCisJZm9yICg7OykgeworCQljaGFyIGMgPSAqcCsrOworCQlpZiAoYyAh
PSAnOicpIHsKKwkJCSpzKysgPSBjOworCQkJaWYgKCFjKQorCQkJCXJldHVybiByZXQ7CisJCX0g
ZWxzZSBpZiAocyArIDIgPiBwKSB7CisJCQlyZXR1cm4gRVJSX1BUUigtRU5BTUVUT09MT05HKTsK
KwkJfSBlbHNlIHsKKwkJCSpzKysgPSAnXFwnOworCQkJKnMrKyA9IGM7CiAJCX0KKwl9Cit9CisK
K3N0YXRpYyBjaGFyICpvdmxfbGF5ZXJfcGF0aChzdHJ1Y3QgZnNfY29udGV4dCAqZmMsIGNvbnN0
IHN0cnVjdCBwYXRoICpwYXRoLAorCQkJICAgIGJvb2wgbG93ZXIsIGNvbnN0IGNoYXIgKm5hbWUp
Cit7CisJY2hhciAqdG1wLCAqcCA9IE5VTEw7CisKKwl0bXAgPSBrbWFsbG9jKFBBVEhfTUFYLCBH
RlBfS0VSTkVMKTsKKwlpZiAodG1wKSB7CisJCXAgPSBkX3BhdGgocGF0aCwgdG1wLCBQQVRIX01B
WCk7CisJCWlmICghSVNfRVJSKHApICYmIGxvd2VyKQorCQkJcCA9IGVzY2FwZV9jb2xvbnModG1w
LCBwKTsKKwkJaWYgKCFJU19FUlIocCkpCisJCQlwID0ga3N0cmR1cChwLCBHRlBfS0VSTkVMKTsK
IAkJa2ZyZWUodG1wKTsKIAl9Ci0JcmV0dXJuIGVycjsKKwlpZiAoSVNfRVJSKHApKQorCQllcnJv
cmZjKGZjLCAiZmFpbGVkIHRvIGdlbmVyYXRlICVzIHBhdGhuYW1lIiwgbmFtZSk7CisKKwlyZXR1
cm4gcCA/OiBFUlJfUFRSKC1FTk9NRU0pOwogfQogCi1zdGF0aWMgaW50IG92bF9wYXJzZV9wYXJh
bV91cHBlcmRpcihjb25zdCBjaGFyICpuYW1lLCBzdHJ1Y3QgZnNfY29udGV4dCAqZmMsCi0JCQkJ
ICAgIGJvb2wgd29ya2RpcikKK3N0YXRpYyBpbnQgb3ZsX2N0eF9yZWFsbG9jX2xvd2VyKHN0cnVj
dCBmc19jb250ZXh0ICpmYykKK3sKKwlzdHJ1Y3Qgb3ZsX2ZzX2NvbnRleHQgKmN0eCA9IGZjLT5m
c19wcml2YXRlOworCXN0cnVjdCBvdmxfZnNfY29udGV4dF9sYXllciAqbDsKKwlzaXplX3QgbnI7
CisKKwlpZiAoY3R4LT5uciA8IGN0eC0+Y2FwYWNpdHkpCisJCXJldHVybiAwOworCisJbnIgPSBt
aW4obWF4KDQwOTYgLyBzaXplb2YoKmwpLCBjdHgtPmNhcGFjaXR5ICogMiksIChzaXplX3QpIE9W
TF9NQVhfU1RBQ0spOworCWwgPSBrcmVhbGxvY19hcnJheShjdHgtPmxvd2VyLCBuciwgc2l6ZW9m
KCpsKSwgR0ZQX0tFUk5FTF9BQ0NPVU5UKTsKKwlpZiAoIWwpCisJCXJldHVybiAtRU5PTUVNOwor
CisJY3R4LT5sb3dlciA9IGw7CisJY3R4LT5jYXBhY2l0eSA9IG5yOworCXJldHVybiAwOworfQor
CitzdGF0aWMgdm9pZCBvdmxfYWRkX2xheWVyKHN0cnVjdCBmc19jb250ZXh0ICpmYywgZW51bSBv
dmxfb3B0IGxheWVyLAorCQkJICBzdHJ1Y3QgcGF0aCAqcGF0aCwgY2hhciAqKnBwKQogewotCWlu
dCBlcnI7CiAJc3RydWN0IG92bF9mcyAqb2ZzID0gZmMtPnNfZnNfaW5mbzsKIAlzdHJ1Y3Qgb3Zs
X2NvbmZpZyAqY29uZmlnID0gJm9mcy0+Y29uZmlnOwogCXN0cnVjdCBvdmxfZnNfY29udGV4dCAq
Y3R4ID0gZmMtPmZzX3ByaXZhdGU7CisJc3RydWN0IG92bF9mc19jb250ZXh0X2xheWVyICpsOwor
CisJc3dpdGNoIChsYXllcikgeworCWNhc2UgT3B0X3dvcmtkaXI6CisJCXN3YXAoY29uZmlnLT53
b3JrZGlyLCAqcHApOworCQlzd2FwKGN0eC0+d29yaywgKnBhdGgpOworCQlicmVhazsKKwljYXNl
IE9wdF91cHBlcmRpcjoKKwkJc3dhcChjb25maWctPnVwcGVyZGlyLCAqcHApOworCQlzd2FwKGN0
eC0+dXBwZXIsICpwYXRoKTsKKwkJYnJlYWs7CisJY2FzZSBPcHRfZGF0YWRpcl9hZGQ6CisJCWN0
eC0+bnJfZGF0YSsrOworCQlmYWxsdGhyb3VnaDsKKwljYXNlIE9wdF9sb3dlcmRpcl9hZGQ6CisJ
CVdBUk5fT04oY3R4LT5uciA+PSBjdHgtPmNhcGFjaXR5KTsKKwkJbCA9ICZjdHgtPmxvd2VyW2N0
eC0+bnIrK107CisJCW1lbXNldChsLCAwLCBzaXplb2YoKmwpKTsKKwkJc3dhcChsLT5uYW1lLCAq
cHApOworCQlzd2FwKGwtPnBhdGgsICpwYXRoKTsKKwkJYnJlYWs7CisJZGVmYXVsdDoKKwkJV0FS
Tl9PTigxKTsKKwl9Cit9CisKK3N0YXRpYyBpbnQgb3ZsX3BhcnNlX2xheWVyKHN0cnVjdCBmc19j
b250ZXh0ICpmYywgc3RydWN0IGZzX3BhcmFtZXRlciAqcGFyYW0sCisJCQkgICBlbnVtIG92bF9v
cHQgbGF5ZXIpCit7CisJY2hhciAqcGF0aG5hbWUgPSBOVUxMLCAqdG1wID0ga3N0cmR1cChwYXJh
bS0+c3RyaW5nLCBHRlBfS0VSTkVMKTsKKwlib29sIGxvd2VyID0gKGxheWVyID09IE9wdF9sb3dl
cmRpcl9hZGQgfHwgbGF5ZXIgPT0gT3B0X2RhdGFkaXJfYWRkKTsKIAlzdHJ1Y3QgcGF0aCBwYXRo
OwotCWNoYXIgKmR1cDsKKwlpbnQgZXJyOwogCi0JZXJyID0gb3ZsX21vdW50X2RpcihuYW1lLCAm
cGF0aCwgdHJ1ZSk7CisJaWYgKHBhcmFtLT50eXBlID09IGZzX3ZhbHVlX2lzX3N0cmluZykgewor
CQlpZiAoIXRtcCkKKwkJCXJldHVybiAtRU5PTUVNOworCQkvKiBsb29rIHVwIHdpdGggdW5lc2Nh
cGVkIHZhbHVlICovCisJCW92bF91bmVzY2FwZSh0bXApOworCQlzd2FwKHBhcmFtLT5zdHJpbmcs
IHRtcCk7CisJfQorCWVyciA9IGZzX2xvb2t1cF9wYXJhbShmYywgcGFyYW0sIGZhbHNlLCBMT09L
VVBfRk9MTE9XLCAmcGF0aCk7CisJaWYgKHBhcmFtLT50eXBlID09IGZzX3ZhbHVlX2lzX3N0cmlu
ZykKKwkJc3dhcChwYXJhbS0+c3RyaW5nLCB0bXApOworCWtmcmVlKHRtcCk7CiAJaWYgKGVycikK
IAkJcmV0dXJuIGVycjsKIAorCWVyciA9IG92bF9tb3VudF9kaXJfY2hlY2soZmMsICZwYXRoLCBs
YXllciwgcGFyYW0tPmtleSk7CisJaWYgKGVycikKKwkJZ290byBwdXRfcGF0aDsKKwogCS8qCi0J
ICogQ2hlY2sgd2hldGhlciB1cHBlciBwYXRoIGlzIHJlYWQtb25seSBoZXJlIHRvIHJlcG9ydCBm
YWlsdXJlcwotCSAqIGVhcmx5LiBEb24ndCBmb3JnZXQgdG8gcmVjaGVjayB3aGVuIHRoZSBzdXBl
cmJsb2NrIGlzIGNyZWF0ZWQKLQkgKiBhcyB0aGUgbW91bnQgYXR0cmlidXRlcyBjb3VsZCBjaGFu
Z2UuCisJICogSWYgY29uZmlndXJpbmcgd2l0aCBGU0NPTkZJR19TRVRfUEFUSC9GU0NPTkZJR19T
RVRfUEFUSF9FTVBUWSwgdGhlbgorCSAqIG5lZWQgdG8gZ2VuZXJhdGUgYSBwYXRoIGZvciBtb3Vu
dCBvcHRpb24gZGlzcGxheS4KIAkgKi8KLQlpZiAoX19tbnRfaXNfcmVhZG9ubHkocGF0aC5tbnQp
KSB7Ci0JCXBhdGhfcHV0KCZwYXRoKTsKLQkJcmV0dXJuIC1FSU5WQUw7Ci0JfQorCWlmIChwYXJh
bS0+dHlwZSA9PSBmc192YWx1ZV9pc19zdHJpbmcpCisJCXN3YXAocGFyYW0tPnN0cmluZywgcGF0
aG5hbWUpOwogCi0JZHVwID0ga3N0cmR1cChuYW1lLCBHRlBfS0VSTkVMKTsKLQlpZiAoIWR1cCkg
ewotCQlwYXRoX3B1dCgmcGF0aCk7Ci0JCXJldHVybiAtRU5PTUVNOwotCX0KLQotCWlmICh3b3Jr
ZGlyKSB7Ci0JCWtmcmVlKGNvbmZpZy0+d29ya2Rpcik7Ci0JCWNvbmZpZy0+d29ya2RpciA9IGR1
cDsKLQkJcGF0aF9wdXQoJmN0eC0+d29yayk7Ci0JCWN0eC0+d29yayA9IHBhdGg7Ci0JfSBlbHNl
IHsKLQkJa2ZyZWUoY29uZmlnLT51cHBlcmRpcik7Ci0JCWNvbmZpZy0+dXBwZXJkaXIgPSBkdXA7
Ci0JCXBhdGhfcHV0KCZjdHgtPnVwcGVyKTsKLQkJY3R4LT51cHBlciA9IHBhdGg7Ci0JfQotCXJl
dHVybiAwOworCWlmICghcGF0aG5hbWUpIHsKKwkJcGF0aG5hbWUgPSBvdmxfbGF5ZXJfcGF0aChm
YywgJnBhdGgsIGxvd2VyLCBwYXJhbS0+a2V5KTsKKwkJZXJyID0gUFRSX0VSUihwYXRobmFtZSk7
CisJCWlmIChJU19FUlIocGF0aG5hbWUpKQorCQkJZ290byBwdXRfcGF0aDsKKworCQlwcl9pbmZv
KCJHZW5lcmF0ZWQgcGF0aG5hbWU6IDwlcz5cbiIsIHBhdGhuYW1lKTsKKwl9CisJZXJyID0gMDsK
KwlpZiAobG93ZXIpCisJCWVyciA9IG92bF9jdHhfcmVhbGxvY19sb3dlcihmYyk7CisJaWYgKCFl
cnIpCisJCW92bF9hZGRfbGF5ZXIoZmMsIGxheWVyLCAmcGF0aCwgJnBhdGhuYW1lKTsKKwlrZnJl
ZShwYXRobmFtZSk7CitwdXRfcGF0aDoKKwlwYXRoX3B1dCgmcGF0aCk7CisJcmV0dXJuIGVycjsK
IH0KIAorCiBzdGF0aWMgdm9pZCBvdmxfcGFyc2VfcGFyYW1fZHJvcF9sb3dlcmRpcihzdHJ1Y3Qg
b3ZsX2ZzX2NvbnRleHQgKmN0eCkKIHsKIAlmb3IgKHNpemVfdCBuciA9IDA7IG5yIDwgY3R4LT5u
cjsgbnIrKykgewpAQCAtMzQ0LDIyNSArNDI4LDUxIEBAIHN0YXRpYyB2b2lkIG92bF9wYXJzZV9w
YXJhbV9kcm9wX2xvd2VyZGkKIH0KIAogLyoKLSAqIFBhcnNlIGxvd2VyZGlyPSBtb3VudCBvcHRp
b246CisgKiBQYXJzZSBsb3dlcmRpcj0gbW91bnQgb3B0aW9uIGluIG9sZCBtb25vbGl0aGljIHN0
eWxlOgogICoKICAqICgxKSBsb3dlcmRpcj0vbG93ZXIxOi9sb3dlcjI6L2xvd2VyMzo6L2RhdGEx
OjovZGF0YTIKICAqICAgICBTZXQgIi9sb3dlcjEiLCAiL2xvd2VyMiIsIGFuZCAiL2xvd2VyMyIg
YXMgbG93ZXIgbGF5ZXJzIGFuZAogICogICAgICIvZGF0YTEiIGFuZCAiL2RhdGEyIiBhcyBkYXRh
IGxvd2VyIGxheWVycy4gQW55IGV4aXN0aW5nIGxvd2VyCiAgKiAgICAgbGF5ZXJzIGFyZSByZXBs
YWNlZC4KLSAqICgyKSBsb3dlcmRpcj06L2xvd2VyNAotICogICAgIEFwcGVuZCAiL2xvd2VyNCIg
dG8gY3VycmVudCBzdGFjayBvZiBsb3dlciBsYXllcnMuIFRoaXMgcmVxdWlyZXMKLSAqICAgICB0
aGF0IHRoZXJlIGFscmVhZHkgaXMgYXQgbGVhc3Qgb25lIGxvd2VyIGxheWVyIGNvbmZpZ3VyZWQu
Ci0gKiAoMykgbG93ZXJkaXI9OjovbG93ZXI1Ci0gKiAgICAgQXBwZW5kIGRhdGEgIi9sb3dlcjUi
IGFzIGRhdGEgbG93ZXIgbGF5ZXIuIFRoaXMgcmVxdWlyZXMgdGhhdAotICogICAgIHRoZXJlJ3Mg
YXQgbGVhc3Qgb25lIHJlZ3VsYXIgbG93ZXIgbGF5ZXIgcHJlc2VudC4KICAqLwotc3RhdGljIGlu
dCBvdmxfcGFyc2VfcGFyYW1fbG93ZXJkaXIoY29uc3QgY2hhciAqbmFtZSwgc3RydWN0IGZzX2Nv
bnRleHQgKmZjKQorc3RhdGljIGludCBvdmxfcGFyc2VfbG93ZXJfbGF5ZXJzKHN0cnVjdCBmc19j
b250ZXh0ICpmYywKKwkJCQkgIHN0cnVjdCBmc19wYXJhbWV0ZXIgKnBhcmFtKQogewotCWludCBl
cnI7CisJaW50IGVyciA9IDA7CiAJc3RydWN0IG92bF9mc19jb250ZXh0ICpjdHggPSBmYy0+ZnNf
cHJpdmF0ZTsKLQlzdHJ1Y3Qgb3ZsX2ZzX2NvbnRleHRfbGF5ZXIgKmw7Ci0JY2hhciAqZHVwID0g
TlVMTCwgKmR1cF9pdGVyOwotCXNzaXplX3QgbnJfbG93ZXIgPSAwLCBuciA9IDAsIG5yX2RhdGEg
PSAwOwotCWJvb2wgYXBwZW5kID0gZmFsc2UsIGRhdGFfbGF5ZXIgPSBmYWxzZTsKLQotCS8qCi0J
ICogRW5zdXJlIHdlJ3JlIGJhY2t3YXJkcyBjb21wYXRpYmxlIHdpdGggbW91bnQoMikKLQkgKiBi
eSBhbGxvd2luZyByZWxhdGl2ZSBwYXRocy4KLQkgKi8KLQotCS8qIGRyb3AgYWxsIGV4aXN0aW5n
IGxvd2VyIGxheWVycyAqLwotCWlmICghKm5hbWUpIHsKLQkJb3ZsX3BhcnNlX3BhcmFtX2Ryb3Bf
bG93ZXJkaXIoY3R4KTsKLQkJcmV0dXJuIDA7Ci0JfQotCi0JaWYgKHN0cm5jbXAobmFtZSwgIjo6
IiwgMikgPT0gMCkgewotCQkvKgotCQkgKiBUaGlzIGlzIGEgZGF0YSBsYXllci4KLQkJICogVGhl
cmUgbXVzdCBiZSBhdCBsZWFzdCBvbmUgcmVndWxhciBsb3dlciBsYXllcgotCQkgKiBzcGVjaWZp
ZWQuCi0JCSAqLwotCQlpZiAoY3R4LT5uciA9PSAwKSB7Ci0JCQlwcl9lcnIoImRhdGEgbG93ZXIg
bGF5ZXJzIHdpdGhvdXQgcmVndWxhciBsb3dlciBsYXllcnMgbm90IGFsbG93ZWQiKTsKLQkJCXJl
dHVybiAtRUlOVkFMOwotCQl9Ci0KLQkJLyogU2tpcCB0aGUgbGVhZGluZyAiOjoiLiAqLwotCQlu
YW1lICs9IDI7Ci0JCWRhdGFfbGF5ZXIgPSB0cnVlOwotCQkvKgotCQkgKiBBIGRhdGEgbGF5ZXIg
aXMgYXV0b21hdGljYWxseSBhbiBhcHBlbmQgYXMgdGhlcmUKLQkJICogbXVzdCd2ZSBiZWVuIGF0
IGxlYXN0IG9uZSByZWd1bGFyIGxvd2VyIGxheWVyLgotCQkgKi8KLQkJYXBwZW5kID0gdHJ1ZTsK
LQl9IGVsc2UgaWYgKCpuYW1lID09ICc6JykgewotCQkvKgotCQkgKiBUaGlzIGlzIGEgcmVndWxh
ciBsb3dlciBsYXllci4KLQkJICogSWYgdXNlcnMgd2FudCB0byBhcHBlbmQgYSBsYXllciBlbmZv
cmNlIHRoYXQgdGhleQotCQkgKiBoYXZlIGFscmVhZHkgc3BlY2lmaWVkIGEgZmlyc3QgbGF5ZXIg
YmVmb3JlLiBJdCdzCi0JCSAqIGJldHRlciB0byBiZSBzdHJpY3QuCi0JCSAqLwotCQlpZiAoY3R4
LT5uciA9PSAwKSB7Ci0JCQlwcl9lcnIoImNhbm5vdCBhcHBlbmQgbGF5ZXIgaWYgbm8gcHJldmlv
dXMgbGF5ZXIgaGFzIGJlZW4gc3BlY2lmaWVkIik7Ci0JCQlyZXR1cm4gLUVJTlZBTDsKLQkJfQot
Ci0JCS8qCi0JCSAqIE9uY2UgYSBzZXF1ZW5jZSBvZiBkYXRhIGxheWVycyBoYXMgc3RhcnRlZCBy
ZWd1bGFyCi0JCSAqIGxvd2VyIGxheWVycyBhcmUgZm9yYmlkZGVuLgotCQkgKi8KLQkJaWYgKGN0
eC0+bnJfZGF0YSA+IDApIHsKLQkJCXByX2VycigicmVndWxhciBsb3dlciBsYXllcnMgY2Fubm90
IGZvbGxvdyBkYXRhIGxvd2VyIGxheWVycyIpOwotCQkJcmV0dXJuIC1FSU5WQUw7Ci0JCX0KLQot
CQkvKiBTa2lwIHRoZSBsZWFkaW5nICI6Ii4gKi8KLQkJbmFtZSsrOwotCQlhcHBlbmQgPSB0cnVl
OwotCX0KKwljaGFyICppdGVyOworCXNzaXplX3QgbnJfbG93ZXIsIG5yOworCWVudW0gb3ZsX29w
dCBsYXllciA9IE9wdF9sb3dlcmRpcl9hZGQ7CiAKLQlkdXAgPSBrc3RyZHVwKG5hbWUsIEdGUF9L
RVJORUwpOwotCWlmICghZHVwKQotCQlyZXR1cm4gLUVOT01FTTsKKwlvdmxfcGFyc2VfcGFyYW1f
ZHJvcF9sb3dlcmRpcihjdHgpOwogCi0JZXJyID0gLUVJTlZBTDsKLQlucl9sb3dlciA9IG92bF9w
YXJzZV9wYXJhbV9zcGxpdF9sb3dlcmRpcnMoZHVwKTsKKwlucl9sb3dlciA9IG92bF9wYXJzZV9w
YXJhbV9zcGxpdF9sb3dlcmRpcnMocGFyYW0tPnN0cmluZyk7CiAJaWYgKG5yX2xvd2VyIDwgMCkK
LQkJZ290byBvdXRfZXJyOworCQlyZXR1cm4gbnJfbG93ZXI7CiAKLQlpZiAoKG5yX2xvd2VyID4g
T1ZMX01BWF9TVEFDSykgfHwKLQkgICAgKGFwcGVuZCAmJiAoc2l6ZV9hZGQoY3R4LT5uciwgbnJf
bG93ZXIpID4gT1ZMX01BWF9TVEFDSykpKSB7Ci0JCXByX2VycigidG9vIG1hbnkgbG93ZXIgZGly
ZWN0b3JpZXMsIGxpbWl0IGlzICVkXG4iLCBPVkxfTUFYX1NUQUNLKTsKLQkJZ290byBvdXRfZXJy
OwotCX0KLQotCWlmICghYXBwZW5kKQotCQlvdmxfcGFyc2VfcGFyYW1fZHJvcF9sb3dlcmRpcihj
dHgpOworCWl0ZXIgPSBwYXJhbS0+c3RyaW5nOworCWZvciAobnIgPSAwOyBuciA8IG5yX2xvd2Vy
OyBucisrKSB7CisJCXN0cnVjdCBmc19wYXJhbWV0ZXIgcCA9IHsKKwkJCS5rZXkgPSAobGF5ZXIg
PT0gT3B0X2xvd2VyZGlyX2FkZCkgPyAibG93ZXJkaXIiIDogImRhdGFkaXIiLAorCQkJLnR5cGUg
PSBmc192YWx1ZV9pc19zdHJpbmcsCisJCQkuc3RyaW5nID0ga3N0cmR1cChpdGVyLCBHRlBfS0VS
TkVMKSwKKwkJfTsKIAotCS8qCi0JICogKDEpIGFwcGVuZAotCSAqCi0JICogV2Ugd2FudCBuciA8
PSBucl9sb3dlciA8PSBjYXBhY2l0eSBXZSBrbm93IG5yID4gMCBhbmQgbnIgPD0KLQkgKiBjYXBh
Y2l0eS4gSWYgbnIgPT0gMCB0aGlzIHdvdWxkbid0IGJlIGFwcGVuZC4gSWYgbnIgKwotCSAqIG5y
X2xvd2VyIGlzIDw9IGNhcGFjaXR5IHRoZW4gbnIgPD0gbnJfbG93ZXIgPD0gY2FwYWNpdHkKLQkg
KiBhbHJlYWR5IGhvbGRzLiBJZiBuciArIG5yX2xvd2VyIGV4Y2VlZHMgY2FwYWNpdHksIHdlIHJl
YWxsb2MuCi0JICoKLQkgKiAoMikgcmVwbGFjZQotCSAqCi0JICogRW5zdXJlIHdlJ3JlIGJhY2t3
YXJkcyBjb21wYXRpYmxlIHdpdGggbW91bnQoMikgd2hpY2ggYWxsb3dzCi0JICogImxvd2VyZGly
PS9hOi9iOi9jLGxvd2VyZGlyPS9kOi9lOi9mIiBjYXVzaW5nIHRoZSBsYXN0Ci0JICogc3BlY2lm
aWVkIGxvd2VyZGlyIG1vdW50IG9wdGlvbiB0byB3aW4uCi0JICoKLQkgKiBXZSB3YW50IG5yIDw9
IG5yX2xvd2VyIDw9IGNhcGFjaXR5IFdlIGtub3cgZWl0aGVyIChpKSBuciA9PSAwCi0JICogb3Ig
KGlpKSBuciA+IDAuIFdlIGFsc28ga25vdyBucl9sb3dlciA+IDAuIFRoZSBjYXBhY2l0eQotCSAq
IGNvdWxkJ3ZlIGJlZW4gY2hhbmdlZCBtdWx0aXBsZSB0aW1lcyBhbHJlYWR5IHNvIHdlIG9ubHkg
a25vdwotCSAqIG5yIDw9IGNhcGFjaXR5LiBJZiBuciArIG5yX2xvd2VyID4gY2FwYWNpdHkgd2Ug
cmVhbGxvYywKLQkgKiBvdGhlcndpc2UgbnIgPD0gbnJfbG93ZXIgPD0gY2FwYWNpdHkgaG9sZHMg
YWxyZWFkeS4KLQkgKi8KLQlucl9sb3dlciArPSBjdHgtPm5yOwotCWlmIChucl9sb3dlciA+IGN0
eC0+Y2FwYWNpdHkpIHsKLQkJZXJyID0gLUVOT01FTTsKLQkJbCA9IGtyZWFsbG9jX2FycmF5KGN0
eC0+bG93ZXIsIG5yX2xvd2VyLCBzaXplb2YoKmN0eC0+bG93ZXIpLAotCQkJCSAgIEdGUF9LRVJO
RUxfQUNDT1VOVCk7Ci0JCWlmICghbCkKLQkJCWdvdG8gb3V0X2VycjsKKwkJaWYgKCFwLnN0cmlu
ZykKKwkJCXJldHVybiAtRU5PTUVNOwogCi0JCWN0eC0+bG93ZXIgPSBsOwotCQljdHgtPmNhcGFj
aXR5ID0gbnJfbG93ZXI7Ci0JfQotCi0JLyoKLQkgKiAgICgzKSBCeSAoMSkgYW5kICgyKSB3ZSBr
bm93IG5yIDw9IG5yX2xvd2VyIDw9IGNhcGFjaXR5LgotCSAqICAgKDQpIElmIGN0eC0+bnIgPT0g
MCA9PiByZXBsYWNlCi0JICogICAgICAgV2UgaGF2ZSB2ZXJpZmllZCBhYm92ZSB0aGF0IHRoZSBs
b3dlcmRpciBtb3VudCBvcHRpb24KLQkgKiAgICAgICBpc24ndCBhbiBhcHBlbmQsIGkuZS4sIHRo
ZSBsb3dlcmRpciBtb3VudCBvcHRpb24KLQkgKiAgICAgICBkb2Vzbid0IHN0YXJ0IHdpdGggIjoi
IG9yICI6OiIuCi0JICogKDQuMSkgVGhlIGxvd2VyZGlyIG1vdW50IG9wdGlvbnMgb25seSBjb250
YWlucyByZWd1bGFyIGxvd2VyCi0JICogICAgICAgbGF5ZXJzICI6Ii4KLQkgKiAgICAgICA9PiBO
b3RoaW5nIHRvIHZlcmlmeS4KLQkgKiAoNC4yKSBUaGUgbG93ZXJkaXIgbW91bnQgb3B0aW9ucyBj
b250YWlucyByZWd1bGFyICI6IiBhbmQKLQkgKiAgICAgICBkYXRhICI6OiIgbGF5ZXJzLgotCSAq
ICAgICAgID0+IFdlIG5lZWQgdG8gdmVyaWZ5IHRoYXQgZGF0YSBsb3dlciBsYXllcnMgIjo6IiBh
cmVuJ3QKLQkgKiAgICAgICAgICBmb2xsb3dlZCBieSByZWd1bGFyICI6IiBsb3dlciBsYXllcnMK
LQkgKiAgICg1KSBJZiBjdHgtPm5yID4gMCA9PiBhcHBlbmQKLQkgKiAgICAgICBXZSBrbm93IHRo
YXQgdGhlcmUncyBhdCBsZWFzdCBvbmUgcmVndWxhciBsYXllcgotCSAqICAgICAgIG90aGVyd2lz
ZSB3ZSB3b3VsZCd2ZSBmYWlsZWQgd2hlbiBwYXJzaW5nIHRoZSBwcmV2aW91cwotCSAqICAgICAg
IGxvd2VyZGlyIG1vdW50IG9wdGlvbi4KLQkgKiAoNS4xKSBUaGUgbG93ZXJkaXIgbW91bnQgb3B0
aW9uIGlzIGEgcmVndWxhciBsYXllciAiOiIgYXBwZW5kCi0JICogICAgICAgPT4gV2UgbmVlZCB0
byB2ZXJpZnkgdGhhdCBubyBkYXRhIGxheWVycyBoYXZlIGJlZW4KLQkgKiAgICAgICAgICBzcGVj
aWZpZWQgYmVmb3JlLgotCSAqICg1LjIpIFRoZSBsb3dlcmRpciBtb3VudCBvcHRpb24gaXMgYSBk
YXRhIGxheWVyICI6OiIgYXBwZW5kCi0JICogICAgICAgV2Uga25vdyB0aGF0IHRoZXJlJ3MgYXQg
bGVhc3Qgb25lIHJlZ3VsYXIgbGF5ZXIgb3IKLQkgKiAgICAgICBvdGhlciBkYXRhIGxheWVycy4g
PT4gVGhlcmUncyBub3RoaW5nIHRvIHZlcmlmeS4KLQkgKi8KLQlkdXBfaXRlciA9IGR1cDsKLQlm
b3IgKG5yID0gY3R4LT5ucjsgbnIgPCBucl9sb3dlcjsgbnIrKykgewotCQlsID0gJmN0eC0+bG93
ZXJbbnJdOwotCQltZW1zZXQobCwgMCwgc2l6ZW9mKCpsKSk7Ci0KLQkJZXJyID0gb3ZsX21vdW50
X2RpcihkdXBfaXRlciwgJmwtPnBhdGgsIGZhbHNlKTsKKwkJZXJyID0gb3ZsX3BhcnNlX2xheWVy
KGZjLCAmcCwgbGF5ZXIpOworCQlrZnJlZShwLnN0cmluZyk7CiAJCWlmIChlcnIpCi0JCQlnb3Rv
IG91dF9wdXQ7Ci0KLQkJZXJyID0gLUVOT01FTTsKLQkJbC0+bmFtZSA9IGtzdHJkdXAoZHVwX2l0
ZXIsIEdGUF9LRVJORUxfQUNDT1VOVCk7Ci0JCWlmICghbC0+bmFtZSkKLQkJCWdvdG8gb3V0X3B1
dDsKLQotCQlpZiAoZGF0YV9sYXllcikKLQkJCW5yX2RhdGErKzsKLQotCQkvKiBDYWxsaW5nIHN0
cmNocigpIGFnYWluIHdvdWxkIG92ZXJydW4uICovCi0JCWlmICgobnIgKyAxKSA9PSBucl9sb3dl
cikKIAkJCWJyZWFrOwogCi0JCWVyciA9IC1FSU5WQUw7Ci0JCWR1cF9pdGVyID0gc3RyY2hyKGR1
cF9pdGVyLCAnXDAnKSArIDE7Ci0JCWlmICgqZHVwX2l0ZXIpIHsKLQkJCS8qCi0JCQkgKiBUaGlz
IGlzIGEgcmVndWxhciBsYXllciBzbyB3ZSByZXF1aXJlIHRoYXQKLQkJCSAqIHRoZXJlIGFyZSBu
byBkYXRhIGxheWVycy4KLQkJCSAqLwotCQkJaWYgKChjdHgtPm5yX2RhdGEgKyBucl9kYXRhKSA+
IDApIHsKLQkJCQlwcl9lcnIoInJlZ3VsYXIgbG93ZXIgbGF5ZXJzIGNhbm5vdCBmb2xsb3cgZGF0
YSBsb3dlciBsYXllcnMiKTsKLQkJCQlnb3RvIG91dF9wdXQ7Ci0JCQl9Ci0KLQkJCWRhdGFfbGF5
ZXIgPSBmYWxzZTsKLQkJCWNvbnRpbnVlOworCQlsYXllciA9IE9wdF9sb3dlcmRpcl9hZGQ7CisJ
CWl0ZXIgPSBzdHJjaHIoaXRlciwgJ1wwJykgKyAxOworCQlpZiAoISppdGVyKSB7CisJCQlsYXll
ciA9IE9wdF9kYXRhZGlyX2FkZDsKKwkJCWl0ZXIrKzsKIAkJfQotCi0JCS8qIFRoaXMgaXMgYSBk
YXRhIGxvd2VyIGxheWVyLiAqLwotCQlkYXRhX2xheWVyID0gdHJ1ZTsKLQkJZHVwX2l0ZXIrKzsK
LQl9Ci0JY3R4LT5uciA9IG5yX2xvd2VyOwotCWN0eC0+bnJfZGF0YSArPSBucl9kYXRhOwotCWtm
cmVlKGR1cCk7Ci0JcmV0dXJuIDA7Ci0KLW91dF9wdXQ6Ci0JLyoKLQkgKiBXZSBrbm93IG5yID49
IGN0eC0+bnIgPCBucl9sb3dlci4gSWYgd2UgZmFpbGVkIHNvbWV3aGVyZQotCSAqIHdlIHdhbnQg
dG8gdW5kbyB1bnRpbCBuciA9PSBjdHgtPm5yLiBUaGlzIGlzIGNvcnJlY3QgZm9yCi0JICogYm90
aCBjdHgtPm5yID09IDAgYW5kIGN0eC0+bnIgPiAwLgotCSAqLwotCWZvciAoOyBuciA+PSBjdHgt
Pm5yOyBuci0tKSB7Ci0JCWwgPSAmY3R4LT5sb3dlcltucl07Ci0JCWtmcmVlKGwtPm5hbWUpOwot
CQlsLT5uYW1lID0gTlVMTDsKLQkJcGF0aF9wdXQoJmwtPnBhdGgpOwotCi0JCS8qIGRvbid0IG92
ZXJmbG93ICovCi0JCWlmIChuciA9PSAwKQotCQkJYnJlYWs7CiAJfQotCi1vdXRfZXJyOgotCWtm
cmVlKGR1cCk7Ci0KLQkvKiBJbnRlbnRpb25hbGx5IGRvbid0IHJlYWxsb2MgdG8gYSBzbWFsbGVy
IHNpemUuICovCiAJcmV0dXJuIGVycjsKIH0KIApAQCAtNjAwLDEzICs1MTAsMTMgQEAgc3RhdGlj
IGludCBvdmxfcGFyc2VfcGFyYW0oc3RydWN0IGZzX2NvbgogCiAJc3dpdGNoIChvcHQpIHsKIAlj
YXNlIE9wdF9sb3dlcmRpcjoKLQkJZXJyID0gb3ZsX3BhcnNlX3BhcmFtX2xvd2VyZGlyKHBhcmFt
LT5zdHJpbmcsIGZjKTsKKwkJZXJyID0gb3ZsX3BhcnNlX2xvd2VyX2xheWVycyhmYywgcGFyYW0p
OwogCQlicmVhazsKKwljYXNlIE9wdF9sb3dlcmRpcl9hZGQ6CisJY2FzZSBPcHRfZGF0YWRpcl9h
ZGQ6CiAJY2FzZSBPcHRfdXBwZXJkaXI6Ci0JCWZhbGx0aHJvdWdoOwogCWNhc2UgT3B0X3dvcmtk
aXI6Ci0JCWVyciA9IG92bF9wYXJzZV9wYXJhbV91cHBlcmRpcihwYXJhbS0+c3RyaW5nLCBmYywK
LQkJCQkJICAgICAgIChPcHRfd29ya2RpciA9PSBvcHQpKTsKKwkJZXJyID0gb3ZsX3BhcnNlX2xh
eWVyKGZjLCBwYXJhbSwgb3B0KTsKIAkJYnJlYWs7CiAJY2FzZSBPcHRfZGVmYXVsdF9wZXJtaXNz
aW9uczoKIAkJY29uZmlnLT5kZWZhdWx0X3Blcm1pc3Npb25zID0gdHJ1ZTsKSW5kZXg6IGxpbnV4
L2ZzL2ZzX3BhcnNlci5jCj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT0KLS0tIGxpbnV4Lm9yaWcvZnMvZnNfcGFyc2VyLmMJ
MjAyMy0xMC0xNCAyMDoxODoyNS41NDg2OTg5OTUgKzAyMDAKKysrIGxpbnV4L2ZzL2ZzX3BhcnNl
ci5jCTIwMjMtMTAtMTQgMjA6MTg6MzAuNDY0NzExMzI4ICswMjAwCkBAIC0xNTAsNiArMTUwLDcg
QEAgaW50IGZzX2xvb2t1cF9wYXJhbShzdHJ1Y3QgZnNfY29udGV4dCAqZgogCXN0cnVjdCBmaWxl
bmFtZSAqZjsKIAlib29sIHB1dF9mOwogCWludCByZXQ7CisJaW50IGRmZCA9IEFUX0ZEQ1dEOwog
CiAJc3dpdGNoIChwYXJhbS0+dHlwZSkgewogCWNhc2UgZnNfdmFsdWVfaXNfc3RyaW5nOgpAQCAt
MTYwLDEzICsxNjEsMTQgQEAgaW50IGZzX2xvb2t1cF9wYXJhbShzdHJ1Y3QgZnNfY29udGV4dCAq
ZgogCQlicmVhazsKIAljYXNlIGZzX3ZhbHVlX2lzX2ZpbGVuYW1lOgogCQlmID0gcGFyYW0tPm5h
bWU7CisJCWRmZCA9IHBhcmFtLT5kaXJmZDsKIAkJcHV0X2YgPSBmYWxzZTsKIAkJYnJlYWs7CiAJ
ZGVmYXVsdDoKIAkJcmV0dXJuIGludmFsZihmYywgIiVzOiBub3QgdXNhYmxlIGFzIHBhdGgiLCBw
YXJhbS0+a2V5KTsKIAl9CiAKLQlyZXQgPSBmaWxlbmFtZV9sb29rdXAocGFyYW0tPmRpcmZkLCBm
LCBmbGFncywgX3BhdGgsIE5VTEwpOworCXJldCA9IGZpbGVuYW1lX2xvb2t1cChkZmQsIGYsIGZs
YWdzLCBfcGF0aCwgTlVMTCk7CiAJaWYgKHJldCA8IDApIHsKIAkJZXJyb3JmKGZjLCAiJXM6IExv
b2t1cCBmYWlsdXJlIGZvciAnJXMnIiwgcGFyYW0tPmtleSwgZi0+bmFtZSk7CiAJCWdvdG8gb3V0
Owo=
--000000000000123f730607b13b92--
